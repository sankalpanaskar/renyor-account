<form #fm="ngForm" (ngSubmit)="onSubmit(fm)" novalidate id="leadFormBulk" style="width: 100%; margin: 0 auto;">
    <div class="row">
        <div class="col-lg-12">
            <nb-card>
                <nb-card-header>Scrap Sell Form</nb-card-header>

                <nb-card-body [nbSpinner]="isSubmitting" nbSpinnerStatus="primary">

                    <!-- ðŸ”Ž Search -->
                    <div class="p-2 border-bottom table-search-bar">
                        <input nbInput fullWidth placeholder="Search Asset..." [(ngModel)]="searchTextStudent"
                            name="searchTextStudent" (ngModelChange)="filterAsset()" />
                    </div>

                    <!-- ðŸ“‹ Asset Table -->
                    <div class="row mt-3" style="margin: 0 4px;">
                        <div class="col-lg-12 table-shell">
                            <div style="max-height: 320px; overflow-y: auto;">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" class="custom-checkbox"
                                                    [(ngModel)]="masterSelected" (change)="selectAll()"
                                                    [ngModelOptions]="{ standalone: true }" />
                                                Select ({{ selectedCount }})
                                            </th>
                                            <th>Sub Class</th>
                                            <th>Brand</th>
                                            <th>Serial No</th>
                                            <th>Center</th>
                                            <th>Purchase Date</th>
                                            <th>Anudip ID</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let asset of filteredAssetList; let i = index">
                                            <td>
                                                <input type="checkbox" class="custom-checkbox-td"
                                                    [(ngModel)]="asset.isSelected" name="leadSelect{{ i }}"
                                                    [ngModelOptions]="{ standalone: true }"
                                                    (change)="checkIfAllSelected()" />
                                            </td>
                                            <td>{{ asset.assets_sub_class }}</td>
                                            <td>{{ asset.brand_name }}</td>
                                            <td>{{ asset.serial_no }}</td>
                                            <td>{{ asset.center_code }}</td>
                                            <td>{{ asset.purchase_date | date:'yyyy-MM-dd' }}</td>
                                            <td>{{ asset.anudip_identification_no }}</td>
                                        </tr>

                                        <tr *ngIf="assetList.length === 0">
                                            <td colspan="7" class="text-center text-muted">No Asset Found</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ðŸ§® Pricing Summary by Sub Class -->
                    <div class="row mt-3" *ngIf="priceRows.length > 0">
                        <div class="col-lg-12">
                            <div class="pricing-box">
                                <div class="pricing-header">
                                    <strong>Pricing Summary</strong>
                                    <small class="text-hint">
                                        Set unit price per Sub Class; totals auto-calculate
                                    </small>
                                </div>

                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th style="width: 35%;">Sub Class</th>
                                            <th style="width: 15%;">Selected Qty</th>
                                            <th style="width: 25%;">Unit Price</th>
                                            <th style="width: 25%;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let row of priceRows; let i = index">
                                            <td class="subclass-cell">
                                                <nb-badge text="{{ row.count }}" status="primary"
                                                    position="left"></nb-badge>
                                                <span>{{ row.subClass }}</span>
                                            </td>
                                            <td>{{ row.count }}</td>
                                            <td>
                                                <input nbInput fullWidth type="number" min="0" step="0.01"
                                                    placeholder="0.00" [(ngModel)]="row.unitPrice"
                                                    name="unitPrice_{{ i }}" (ngModelChange)="recalcTotals()" />
                                            </td>
                                            <td>
                                                <strong>{{ row.total | number: '1.2-2' }}</strong>
                                            </td>
                                        </tr>
                                    </tbody>

                                    <!-- ðŸ”» Footer with separate GST / TCS rows -->
                                    <tfoot>
                                        <tr>
                                            <th colspan="3" class="text-end">Subtotal</th>
                                            <th>
                                                <strong>{{ baseTotal | number: '1.2-2' }}</strong>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th colspan="3" class="text-end">GST Amount</th>
                                            <th>
                                                <strong>{{ (+model.gst_amount || 0) | number: '1.2-2' }}</strong>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th colspan="3" class="text-end">TCS Amount</th>
                                            <th>
                                                <strong>{{ (+model.tcs_amount || 0) | number: '1.2-2' }}</strong>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th colspan="3" class="text-end">Grand Total</th>
                                            <th>
                                                <strong>{{ grandTotal | number: '1.2-2' }}</strong>
                                            </th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ðŸ‘¤ Buyer Dropdown -->
                    <div class="row mt-3">
                        <div class="col-lg-12">
                            <label class="small-label" id="label-category">
                                Select Buyer<span style="color:#d32f2f">*</span>
                            </label>

                            <div class="custom-select" #dropdownTrigger
                                [class.invalid]="fm.submitted && buyer_name.invalid" (click)="toggleDropdown()">
                                <span class="truncate-text" [ngClass]="{ 'placeholder': !model.buyer_name }">
                                    <ng-container *ngIf="model.buyer_name; else placeholderTextBuyer">
                                        {{ model.buyer_name }}
                                    </ng-container>
                                    <ng-template #placeholderTextBuyer>
                                        Select Buyer
                                    </ng-template>
                                </span>

                                <nb-icon [icon]="dropdownOpen ? 'chevron-up-outline' : 'chevron-down-outline'"
                                    pack="eva"></nb-icon>
                            </div>

                            <!-- Form Binding for Validation -->
                            <input type="text" name="buyer_name" [(ngModel)]="model.buyer_name" #buyer_name="ngModel"
                                required hidden />

                            <!-- Dropdown with dynamic direction -->
                            <div class="custom-dropdown" [ngClass]="{ 'open-up': openAbove, 'open-down': !openAbove }"
                                *ngIf="dropdownOpen">
                                <input nbInput fullWidth placeholder="Search..." [(ngModel)]="searchText"
                                    name="buyerSearch" (ngModelChange)="filterOptions()" />

                                <div *ngFor="let buyer of filterBuyerList" (click)="selectFunder(buyer.name)"
                                    class="dropdown-item">
                                    {{ buyer.name }} ({{ buyer.buyer_id }})
                                </div>

                                <div *ngIf="filterBuyerList.length === 0" class="dropdown-item disabled">
                                    No Buyer found
                                </div>
                            </div>

                            <div *ngIf="fm.submitted && buyer_name.invalid" class="error-message">
                                Buyer is required
                            </div>
                        </div>
                    </div>

                    <!-- ðŸ’¸ GST & TCS Inputs -->
                    <div class="row mt-3">
                        <div class="col-lg-6">
                            <label class="small-label" id="label-category">
                                GST Amount <span style="color:#d32f2f">*</span>
                            </label>
                            <input type="number" nbInput fullWidth shape="semi-round" placeholder="Enter GST amount"
                                name="gst_amount" required #gst_amount="ngModel" [(ngModel)]="model.gst_amount"
                                (ngModelChange)="recalcTotals()" />
                            <div *ngIf="fm.submitted && gst_amount.invalid" class="error-message">
                                GST Amount is required
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <label class="small-label" id="label-category">
                                TCS Amount <span style="color:#d32f2f">*</span>
                            </label>
                            <input type="number" nbInput fullWidth shape="semi-round" placeholder="Enter TCS amount"
                                name="tcs_amount" required #tcs_amount="ngModel" [(ngModel)]="model.tcs_amount"
                                (ngModelChange)="recalcTotals()" />
                            <div *ngIf="fm.submitted && tcs_amount.invalid" class="error-message">
                                TCS Amount is required
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <label class="small-label" id="label-category">
                                Invoice No <span style="color:#d32f2f">*</span>
                            </label>
                            <input type="text" nbInput fullWidth shape="semi-round" placeholder="Enter Invoice No"
                                name="invoice_no" required #invoice_no="ngModel" [(ngModel)]="model.invoice_no"
                                (ngModelChange)="recalcTotals()" />
                            <div *ngIf="fm.submitted && invoice_no.invalid" class="error-message">
                                Invoice no is required
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <label class="small-label" id="label-category">Sale date<span
                                    style="color:#d32f2f">*</span></label>
                            <input nbInput fullWidth placeholder="Select Purchase date" [readonly]="true"
                                [nbDatepicker]="datePicker" [(ngModel)]="model.invoice_date" name="invoice_date"
                                required #invoice_date="ngModel" />
                            <nb-datepicker #datePicker></nb-datepicker>
                            <div *ngIf="fm.submitted && invoice_date.invalid" class="error-message">Sale date is
                                required</div>

                        </div>
                    </div>

                    <div class="row">

                        <div class="col-lg-12">
                            <label class="small-label" id="label-category">
                                Remarks
                                <!-- <span style="color:#d32f2f">*</span> -->
                            </label>
                            <textarea nbInput fullWidth placeholder="Add remarks (optional)" name="remarks"
                                [(ngModel)]="model.remarks" #remarks="ngModel" rows="2" [maxlength]="500">
                        </textarea>

                            <!-- character counter -->
                            <div style="font-size: 12px; color:#6c757d; margin-top: 4px;">
                                {{ (model.remarks?.length || 0) }}/500
                            </div>

                            <!-- If you want Remarks to be required, add 'required' above and use this error -->
                            <div *ngIf="fm.submitted && remarks.invalid" class="error-message">Remarks are required
                            </div>
                        </div>

                    </div>

                    <!-- âœ… Submit -->
                    <button nbButton status="primary" shape="semi-round" hero type="submit" [disabled]="isSubmitting">
                        Save
                    </button>

                </nb-card-body>
            </nb-card>
        </div>
    </div>
</form>